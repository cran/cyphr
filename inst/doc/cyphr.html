<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Rich FitzJohn" />

<meta name="date" content="2019-03-22" />

<title>Introduction</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Introduction</h1>
<h4 class="author"><em>Rich FitzJohn</em></h4>
<h4 class="date"><em>2019-03-22</em></h4>



<p>This package tries to smooth over some of the differences in encryption approaches (symmetric vs. asymmetric, sodium vs. openssl) to provide a simple interface for users who just want to encrypt or decrypt things.</p>
<p>The scope of the package is to protect data that has been saved to disk. It is not designed to stop an attacker targeting the R process itself to determine the contents of sensitive data. The package does try to prevent you accidentally saving to disk the contents of sensitive information, including the keys that could decrypt such information.</p>
<p>This vignette works through the basic functionality of the package. It does not offer much in the way of an introduction to encryption itself; for that see the excellent vignettes in the <code>openssl</code> and <code>sodium</code> packages (see <code>vignette(&quot;crypto101&quot;)</code> and <code>vignette(&quot;bignum&quot;)</code> for information about how encryption works). This package is a wrapper around those packages in order to make them more accessible.</p>
<div id="keys-and-the-like" class="section level1">
<h1>Keys and the like</h1>
<p>To encrypt anything we need a key. There are two sorts of key “types” we will concern ourselves with here “symmetric” and “asymmetric”.</p>
<ul>
<li><p>“symmetric” keys are used for storing secrets that multiple people need to access. Everyone has the same key (which is just a bunch of bytes) and with that we can either encrypt data or decrypt it.</p></li>
<li><p>a “key pair” is a public and a private key; this is used in communication. You hold a private key that nobody else ever sees and a public key that you can copy around all over the show. These can be used for a couple of different patterns of communication (see below).</p></li>
</ul>
<p>We support symmetric keys and asymmetric key pairs from the <code>openssl</code> and <code>sodium</code> packages (which wrap around industry-standard cryptographic libraries) - this vignette will show how to create and load keys of different types as they’re used.</p>
<p>The <code>openssl</code> keys have the advantage of a standard key format, and that many people (especially on Linux and macOS) have a keypair already (see below if you’re not sure if you do). The <code>sodium</code> keys have the advantage of being a new library, starting from a clean slate rather than carrying with it accumulated ideas from the last 20 years of development.</p>
<p>The idea in <code>cyphr</code> is that we can abstract away some differences in the types of keys and the functions that go with them to create a standardised interface to encrypting and decrypting strings, R objects, files and raw vectors. With that, we can then create wrappers around functions that create files and simplify the process of adding encryption into a data workflow.</p>
<p>Below, I’ll describe the sorts of keys that <code>cyphr</code> supports and in the sections following describe how these can be used to actually do some encryption.</p>
<div id="symmetric-encryption" class="section level2">
<h2>Symmetric encryption</h2>
<p>This is the simplest form of encryption because everyone has the same key (like a key to your house or a single password). This raises issues (like how do you <em>store</em> the key without other people reading it) but we can deal with that below.</p>
<div id="openssl" class="section level3">
<h3><code>openssl</code></h3>
<p>To generate a key with <code>openssl</code>, you can use:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">k &lt;-<span class="st"> </span>openssl<span class="op">::</span><span class="kw">aes_keygen</span>()</a></code></pre></div>
<p>which generates a raw vector</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">k</a></code></pre></div>
<pre><code>## aes raw 45:31:02:6f:2b:50:2a:3b:57:6e:f6:1a:a1:da:cb:cf</code></pre>
<p>(this prints nicely but it really is stored as a 16 byte raw vector).</p>
<p>The encryption functions that this key supports are <code>openssl::aes_cbc_encrypt</code>, <code>openssl::aes_ctr_encrypt</code> and <code>openssl::aes_gcm_encrypt</code> (along with the corresponding decryption functions). The <code>cyphr</code> package tries to abstract this away by using a wrapper `cyphr::key_openssl</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">key &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">key_openssl</span>(k)</a>
<a class="sourceLine" id="cb4-2" title="2">key</a></code></pre></div>
<pre><code>## &lt;cyphr_key: openssl&gt;</code></pre>
<p>With this key, one can encrypt a string with <code>cyphr::encrypt_string</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">secret &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">encrypt_string</span>(<span class="st">&quot;my secret string&quot;</span>, key)</a></code></pre></div>
<p>and decrypt it again with <code>cyphr::decrypt_string</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt_string</span>(secret, key)</a></code></pre></div>
<pre><code>## [1] &quot;my secret string&quot;</code></pre>
<p>See below for more functions that use these key objects.</p>
</div>
<div id="sodium" class="section level3">
<h3><code>sodium</code></h3>
<p>The interface is almost identical using sodium symmetric keys. To generate a symmetric key with libsodium you would use <code>sodium::keygen</code></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">k &lt;-<span class="st"> </span>sodium<span class="op">::</span><span class="kw">keygen</span>()</a></code></pre></div>
<p>This is really just a raw vector of length 32, without even any class attribute!</p>
<p>The encryption functions that this key supports are <code>sodium::data_encrypt</code> and <code>sodium::data_decrypt</code>. To create a key for use with <code>cyphr</code> that knows this, use:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">key &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">key_sodium</span>(k)</a>
<a class="sourceLine" id="cb10-2" title="2">key</a></code></pre></div>
<pre><code>## &lt;cyphr_key: sodium&gt;</code></pre>
<p>This key can then be used with the high-level cyphr encryption functions described below.</p>
</div>
</div>
<div id="asymmetric-encryption-key-pairs" class="section level2">
<h2>Asymmetric encryption (“key pairs”)</h2>
<p>With asymmetric encryption everybody has two keys that differ from everyone else’s key. One key is public and can be shared freely with anyone you would like to communicate with and the other is private and must never be disclosed.</p>
<p>In the <code>sodium</code> package there is a vignette (<code>vignette(&quot;crypto101&quot;)</code>) that gives a gentle introduction to how this all works. In practice, you end up creating a pair of keys for yourself. Then to encrypt or decrypt something you encrypt messages with the recipient’s <em>public key</em> and they (and only they) can decrypt it with their <em>private key</em>.</p>
<p>One use for asymmetric encryption is to encrypt a shared secret (such as a symmetric key) - with this you can then safely store or communicate a symmetric key without disclosing it.</p>
<div id="openssl-1" class="section level3">
<h3><code>openssl</code></h3>
<p>Let’s suppose that we have two parties “Alice” and “Bob” who want to talk with one another. For demonstration purposes we need to generate SSH keys (with no password) in temporary directories (to comply with CRAN policies). In a real situation these would be on different machines (Alice has no access to Bob’s key!) and these keys would be password protected.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">path_key_alice &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">ssh_keygen</span>(<span class="dt">password =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb12-2" title="2">path_key_bob &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">ssh_keygen</span>(<span class="dt">password =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>Note that each directory contains a public key (<code>id_rsa.pub</code>) and a private key (<code>id_rsa</code>).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">dir</span>(path_key_alice)</a></code></pre></div>
<pre><code>## [1] &quot;id_rsa&quot;     &quot;id_rsa.pub&quot;</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">dir</span>(path_key_bob)</a></code></pre></div>
<pre><code>## [1] &quot;id_rsa&quot;     &quot;id_rsa.pub&quot;</code></pre>
<p>Below, the full path to the key (e.g., <code>.../id_rsa</code>) could be used in place of the directory name if you prefer.</p>
<p>If Alice wants to send a message to Bob she needs to use her private key and his public key</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">pair_a &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">keypair_openssl</span>(path_key_bob, path_key_alice)</a>
<a class="sourceLine" id="cb17-2" title="2">pair_a</a></code></pre></div>
<pre><code>## &lt;cyphr_keypair: openssl&gt;</code></pre>
<p>with this pair she can write a message to “bob”:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">secret &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">encrypt_string</span>(<span class="st">&quot;secret message&quot;</span>, pair_a)</a></code></pre></div>
<p>The secret is now just a big pile of bytes</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">secret</a></code></pre></div>
<pre><code>##   [1] 58 0a 00 00 00 02 00 03 05 02 00 02 03 00 00 00 02 13 00 00 00 04 00
##  [24] 00 00 18 00 00 00 10 63 6b d1 89 27 49 74 84 ed 7b 19 ce 74 4a 43 c2
##  [47] 00 00 00 18 00 00 01 00 7c 1b f9 17 f8 2c 08 75 9a bf e0 8e c4 9a 0b
##  [70] 37 9d f1 c1 9f c8 98 a8 21 b0 2c c6 23 5e 64 4b 8d df b5 59 40 ba c2
##  [93] 75 f9 8a 35 2b a9 af d4 5d f1 c9 73 2f 13 c1 34 a4 7f af 38 e9 b8 bc
## [116] 90 83 a1 cb 7f 29 32 c4 92 0c 0d 37 2c 2d a3 a9 0f fd 54 80 b2 71 eb
## [139] 8c 0d c5 8a d5 d3 96 42 41 d4 c6 d1 27 91 10 96 70 e9 48 25 04 97 78
## [162] 4b bb f2 a9 e2 5e 9d a5 ef 2e d4 f6 d1 2e 2b e3 98 f8 4f 3b 4b ac e5
## [185] 25 02 45 43 91 92 19 fc 29 51 4f a1 66 64 65 cd bc 8e dc d6 3d f2 d3
## [208] 5e d1 34 8f 25 8f b1 5f 0c b7 0b 6c 41 74 71 71 9c e8 b0 45 42 d0 d8
## [231] de ae 47 6d 35 ea ac a5 82 69 dc 38 1a e1 0b 68 04 71 94 94 e6 cd 8e
## [254] 84 df 35 0f 0d 64 ef 10 b3 cb 25 f7 b1 fc 5b cb f0 0b e2 76 27 e1 b7
## [277] a3 25 0d 28 7d 98 56 fe 19 e2 f9 e9 19 b4 24 78 02 fe 29 4a 04 d6 79
## [300] 7d ab 79 d1 56 1f be e5 e3 2a 38 00 00 00 18 00 00 00 10 5b 53 fa c5
## [323] 7c 23 8b 13 d8 b3 98 f4 59 20 86 e3 00 00 00 18 00 00 01 00 68 ba 10
## [346] 21 9c e9 67 05 dc b9 5e bc b2 87 0c 3a 1b 59 2d 5c a9 06 56 ef 68 d6
## [369] 97 94 65 ca 1a 39 bf 1c b8 fc 53 e7 de 2a 11 2e b5 04 a5 8e 24 45 a3
## [392] 32 02 46 b7 10 0a 2b 4f 44 f1 2b 0b 55 77 d8 ac b7 a1 71 15 51 e7 cc
## [415] 1f b9 ae 07 43 a4 78 2c 9b 10 a5 97 0d fe 02 9e 02 25 6f 4e 63 53 85
## [438] b6 8f 1e 91 60 be ad d6 fd 7b 40 75 aa f6 fd fb 0e 9f 89 13 96 3d c9
## [461] e4 c6 3c 35 e7 ad 27 b6 6b 82 55 b5 11 ad 98 5c d1 bc 27 04 5a 99 cb
## [484] 35 94 51 58 4b 51 6c fe 4f 2c 1f 19 8a 7a 66 8c 0f 92 3e b9 f3 59 09
## [507] fc a5 7d 49 bf de a5 83 7e a3 21 b0 e7 1a 5f cf b8 e0 a9 7c 68 7b 1d
## [530] 45 70 77 34 c6 1f d5 d3 00 60 a8 86 6a 52 4d a0 14 94 3f 00 13 08 ea
## [553] 32 6c 06 2c f2 a6 af b3 93 04 ed 4b 17 87 b8 70 8d f7 e4 41 37 78 2f
## [576] 9a 74 6b d9 5d 70 f2 6e 50 cd 6d 7b 98 27 1a 5e 30 70 c9 d4 ac d8 a4
## [599] 00 00 04 02 00 00 00 01 00 04 00 09 00 00 00 05 6e 61 6d 65 73 00 00
## [622] 00 10 00 00 00 04 00 04 00 09 00 00 00 02 69 76 00 04 00 09 00 00 00
## [645] 07 73 65 73 73 69 6f 6e 00 04 00 09 00 00 00 04 64 61 74 61 00 04 00
## [668] 09 00 00 00 09 73 69 67 6e 61 74 75 72 65 00 00 00 fe</code></pre>
<p>Note that unlike symmetric encryption above, Alice cannot decrypt her own message:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt_string</span>(secret, pair_a)</a></code></pre></div>
<pre><code>## Error: OpenSSL error in RSA_padding_check_PKCS1_type_2: pkcs decoding error</code></pre>
<p>For Bob to read the message, he uses his private key and Alice’s public key (which she has transmitted to him previously).</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">pair_b &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">keypair_openssl</span>(path_key_alice, path_key_bob)</a></code></pre></div>
<p>With this keypair, Bob can decrypt Alice’s message</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt_string</span>(secret, pair_b)</a></code></pre></div>
<pre><code>## [1] &quot;secret message&quot;</code></pre>
<p>And send one back of his own:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">secret2 &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">encrypt_string</span>(<span class="st">&quot;another message&quot;</span>, pair_b)</a>
<a class="sourceLine" id="cb27-2" title="2">secret2</a></code></pre></div>
<pre><code>##   [1] 58 0a 00 00 00 02 00 03 05 02 00 02 03 00 00 00 02 13 00 00 00 04 00
##  [24] 00 00 18 00 00 00 10 9d bb cf c7 59 6a 7a 44 d6 c1 1d db 07 1f c1 d5
##  [47] 00 00 00 18 00 00 01 00 1a 44 92 13 4f 25 6d 89 a0 60 2b 16 d9 f5 a8
##  [70] 1d a4 d3 f8 90 94 93 fd b8 b2 59 f9 e1 80 86 61 77 73 0c b7 43 e0 61
##  [93] de 10 9f ad ac f5 ee 8e 4c 61 67 e0 b4 3e 91 51 e0 6b d2 32 ff a9 33
## [116] f5 52 2c 32 9d 75 34 56 bf e5 2b d2 df d3 09 d2 05 bd 70 75 28 14 00
## [139] 9f 27 3d 6a bf 26 88 d4 bc a3 61 2f 24 b6 0d ba da 71 e7 f2 af f9 c9
## [162] dd 07 79 8f 63 3e 5c f1 f2 62 4e ce 25 c6 24 b3 77 d4 1d 62 92 db 5b
## [185] 7e b0 75 1a 5e 2f 5c 2a 33 46 64 f4 79 f2 36 2e 9e 8d 76 c9 9c bf 63
## [208] 94 3e 05 3e 1f 90 77 7c 7d ab c5 28 16 d9 f9 3b 22 3a 7a 48 f8 21 0d
## [231] 52 2d 18 47 ff 76 1d 67 56 e9 e5 f2 66 94 91 b7 18 89 56 ce 35 41 84
## [254] 96 b5 21 ad 83 59 a4 f3 16 25 d6 17 6b ed 72 6c 23 af 51 97 3a 70 e1
## [277] ee c5 82 41 ca 36 7c f2 5f a7 0a 27 d2 2e 99 e6 8e 03 e3 f4 84 27 64
## [300] 1b 30 87 a3 4e 5d 27 38 01 f5 1f 00 00 00 18 00 00 00 10 56 5e fc 6a
## [323] 14 3b 63 3e 04 c2 62 c5 b1 9e 4c 9a 00 00 00 18 00 00 01 00 9b 1b 11
## [346] 23 fb 62 67 68 2f 26 7b e1 45 90 63 a4 77 d8 6f 87 16 8b c1 11 b3 77
## [369] c6 db d0 3b 85 21 19 b5 18 e4 56 5a 62 82 7a 09 15 d5 17 78 b1 a9 34
## [392] 33 1d e7 b1 23 95 b0 62 f6 62 64 6b df 85 ea 75 dd de 9d 60 db e6 d4
## [415] c6 fb b3 1f 76 60 44 d8 4a cb 28 47 35 7c 01 fb 69 88 b6 9a 6d f7 f5
## [438] ce c7 40 9c 6b 4a e5 3f 2a 0c 12 76 f3 e8 52 81 9f 9d a7 fb e9 2c 7d
## [461] 1a b4 50 5e 29 3e d2 9f 9b 9a ec 47 64 28 95 6e be c5 f6 d7 d4 04 02
## [484] 96 b5 df 4e 48 da 6c 77 85 ea f7 f1 c9 10 75 36 23 91 5b bb 7f 31 49
## [507] b0 24 c8 b7 f3 9a a6 fb 01 73 fc 08 08 ca bc 24 fd ea bc 9b a2 a2 ce
## [530] a3 d4 3c 4d f4 d3 58 d0 a2 16 96 fc e7 2b 19 7f fd c0 41 40 93 0d 12
## [553] 05 3a 49 4b 5b d9 fd b2 11 00 08 a1 f5 f1 58 c2 a3 7a bf f0 7c f5 ae
## [576] cb c7 13 48 75 5f af d1 01 03 4e 05 79 92 36 12 27 6c 0d bd 1a 62 8d
## [599] 00 00 04 02 00 00 00 01 00 04 00 09 00 00 00 05 6e 61 6d 65 73 00 00
## [622] 00 10 00 00 00 04 00 04 00 09 00 00 00 02 69 76 00 04 00 09 00 00 00
## [645] 07 73 65 73 73 69 6f 6e 00 04 00 09 00 00 00 04 64 61 74 61 00 04 00
## [668] 09 00 00 00 09 73 69 67 6e 61 74 75 72 65 00 00 00 fe</code></pre>
<p>which she can decrypt</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt_string</span>(secret2, pair_a)</a></code></pre></div>
<pre><code>## [1] &quot;another message&quot;</code></pre>
<p>Chances are, you have an openssl keypair in your <code>.ssh/</code> directory. If so, you would pass <code>NULL</code> as the path for the private (or less usefully, the public) key pair part. So to send a message to Bob, we’d include the path to Bob’s public key.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1">pair_us &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">keypair_openssl</span>(path_key_bob, <span class="ot">NULL</span>)</a></code></pre></div>
<p>This all skips over how Alice and Bob will exchange this secret information. Because the secret is bytes, it’s a bit odd to work with. Alice could save the secret to disk with</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1">secret &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">encrypt_string</span>(<span class="st">&quot;secret message&quot;</span>, pair_a)</a>
<a class="sourceLine" id="cb32-2" title="2">path_for_bob &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;for_bob_only&quot;</span>)</a>
<a class="sourceLine" id="cb32-3" title="3"><span class="kw">writeBin</span>(secret, path_for_bob)</a></code></pre></div>
<p>And then send Bob the file <code>for_bob_only</code> (over email or any other insecure medium).</p>
<p>and bob could read the secret in with:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">secret &lt;-<span class="st"> </span><span class="kw">readBin</span>(path_for_bob, <span class="kw">raw</span>(), <span class="kw">file.size</span>(path_for_bob))</a>
<a class="sourceLine" id="cb33-2" title="2">cyphr<span class="op">::</span><span class="kw">decrypt_string</span>(secret, pair_b)</a></code></pre></div>
<pre><code>## [1] &quot;secret message&quot;</code></pre>
<p>As an alternative, you can “base64 encode” the bytes into something that you can just email around:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">secret_base64 &lt;-<span class="st"> </span>openssl<span class="op">::</span><span class="kw">base64_encode</span>(secret)</a>
<a class="sourceLine" id="cb35-2" title="2">secret_base64</a></code></pre></div>
<pre><code>## [1] &quot;WAoAAAACAAMFAgACAwAAAAITAAAABAAAABgAAAAQrno7Y3Q+lwaQxh78eQxsAQAAABgAAAEAinJlFmCOb74GmHzymm1XHfjIlKwAHmwx7UDHDqoy5b/Ad9Vuy4hPqwJM3bjH5+mPMTr+bzz/mi1CH7zQ2fXpW3VNPE091ZLTQWW7JO+s2qqn/H/TyHXQrdsO0rMJTnNg62UFeMn17VZskDedOyahS3HNDs/qNUGF3IKJ7Gf68Rhpb96r30uWCYwXI01apFBx5BSFroM6UJUTQiCMg6LkqxMM/28TI0AkwCzw2+V/2zxEBxAY6+gTAE0PoTEzFw0zjPHz2wgfnU3q8/rX6Fwqt+AoBtZnbZjywIbgaosJqipK83awBkfhae+w08O/x9YXSRr+6EuXorSz1ybsY3Ph1QAAABgAAAAQT+3sDUAtQ5Gp/4pOE4rTDQAAABgAAAEAaLoQIZzpZwXcuV68socMOhtZLVypBlbvaNaXlGXKGjm/HLj8U+feKhEutQSljiRFozICRrcQCitPRPErC1V32Ky3oXEVUefMH7muB0OkeCybEKWXDf4CngIlb05jU4W2jx6RYL6t1v17QHWq9v37Dp+JE5Y9yeTGPDXnrSe2a4JVtRGtmFzRvCcEWpnLNZRRWEtRbP5PLB8ZinpmjA+SPrnzWQn8pX1Jv96lg36jIbDnGl/PuOCpfGh7HUVwdzTGH9XTAGCohmpSTaAUlD8AEwjqMmwGLPKmr7OTBO1LF4e4cI335EE3eC+adGvZXXDyblDNbXuYJxpeMHDJ1KzYpAAABAIAAAABAAQACQAAAAVuYW1lcwAAABAAAAAEAAQACQAAAAJpdgAEAAkAAAAHc2Vzc2lvbgAEAAkAAAAEZGF0YQAEAAkAAAAJc2lnbmF0dXJlAAAA/g==&quot;</code></pre>
<p>This can be converted back with <code>openssl::base64_decode</code>:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1"><span class="kw">identical</span>(openssl<span class="op">::</span><span class="kw">base64_decode</span>(secret_base64), secret)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Or, less compactly but also suitable for email, you might just convert the bytes into their hex representation:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1">secret_hex &lt;-<span class="st"> </span>sodium<span class="op">::</span><span class="kw">bin2hex</span>(secret)</a>
<a class="sourceLine" id="cb39-2" title="2">secret_hex</a></code></pre></div>
<pre><code>## [1] &quot;580a00000002000305020002030000000213000000040000001800000010ae7a3b63743e970690c61efc790c6c0100000018000001008a726516608e6fbe06987cf29a6d571df8c894ac001e6c31ed40c70eaa32e5bfc077d56ecb884fab024cddb8c7e7e98f313afe6f3cff9a2d421fbcd0d9f5e95b754d3c4d3dd592d34165bb24efacdaaaa7fc7fd3c875d0addb0ed2b3094e7360eb650578c9f5ed566c90379d3b26a14b71cd0ecfea354185dc8289ec67faf118696fdeabdf4b96098c17234d5aa45071e41485ae833a50951342208c83a2e4ab130cff6f13234024c02cf0dbe57fdb3c44071018ebe813004d0fa13133170d338cf1f3db081f9d4deaf3fad7e85c2ab7e02806d6676d98f2c086e06a8b09aa2a4af376b00647e169efb0d3c3bfc7d617491afee84b97a2b4b3d726ec6373e1d500000018000000104fedec0d402d4391a9ff8a4e138ad30d000000180000010068ba10219ce96705dcb95ebcb2870c3a1b592d5ca90656ef68d6979465ca1a39bf1cb8fc53e7de2a112eb504a58e2445a3320246b7100a2b4f44f12b0b5577d8acb7a1711551e7cc1fb9ae0743a4782c9b10a5970dfe029e02256f4e635385b68f1e9160beadd6fd7b4075aaf6fdfb0e9f8913963dc9e4c63c35e7ad27b66b8255b511ad985cd1bc27045a99cb359451584b516cfe4f2c1f198a7a668c0f923eb9f35909fca57d49bfdea5837ea321b0e71a5fcfb8e0a97c687b1d45707734c61fd5d30060a8866a524da014943f001308ea326c062cf2a6afb39304ed4b1787b8708df7e44137782f9a746bd95d70f26e50cd6d7b98271a5e3070c9d4acd8a4000004020000000100040009000000056e616d6573000000100000000400040009000000026976000400090000000773657373696f6e00040009000000046461746100040009000000097369676e6174757265000000fe&quot;</code></pre>
<p>and the reverse with <code>sodium::hex2bin</code>:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1"><span class="kw">identical</span>(sodium<span class="op">::</span><span class="kw">hex2bin</span>(secret_hex), secret)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>(this is somewhat less space efficient than base64 encoding.</p>
<p>As a final option, you can just save the secret with <code>saveRDS</code> and read it in with <code>readRDS</code> like any other option. This will be the best route if the secret is saved into a more complicated R object (e.g., a list or <code>data.frame</code>).</p>
<p>See the other cyphr vignette (<code>vignette(&quot;data&quot;, package = &quot;cyphr&quot;)</code>) for a suggested workflow for exchanging secrets within a team, and the wrapper functions below for more convenient ways of working with encrypted data.</p>
<p><strong>Do you already have an ssh keypair?</strong> To find out, run</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1">cyphr<span class="op">::</span><span class="kw">keypair_openssl</span>(<span class="ot">NULL</span>, <span class="ot">NULL</span>)</a></code></pre></div>
<p>One of three things will happen:</p>
<ol style="list-style-type: decimal">
<li><p>you will be prompted for your password to decrypt your private key, and then after entering it an object <code>&lt;cyphr_keypair: openssl&gt;</code> will be returned - you’re good to go!</p></li>
<li><p>you were <em>not</em> prompted for your password, but got a <code>&lt;cyphr_keypair: openssl&gt;</code> object. You should consider whether this is appropriate and consider generating a new keypair with the private key encrypted. If you don’t then anyone who can read your private key can decrypt any message intended for you.</p></li>
<li><p>you get an error like <code>Did not find default ssh public key at ~/.ssh/id_rsa.pub</code>. You need to create a keypair.</p></li>
</ol>
<p>To create a keypair, you can use the <code>cyphr::ssh_keygen()</code> function as</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1">cyphr<span class="op">::</span><span class="kw">ssh_keygen</span>(<span class="st">&quot;~/.ssh&quot;</span>)</a></code></pre></div>
<p>This will create the keypair as <code>~/.ssh/id_rsa</code> and <code>~/.ssh/id_rsa.pub</code>, which is where <code>cyphr</code> will look for your keys by default. See <code>?ssh_keygen</code> for more information. (On Linux and macOS you might use the <code>ssh-keygen</code> command line utility. On windows, PuTTY` has a utility for creating keys.)</p>
</div>
<div id="sodium-1" class="section level3">
<h3><code>sodium</code></h3>
<p>With <code>sodium</code>, things are largely the same with the exception that there is no standard format for saving sodium keys. The bits below use an in-memory key (which is just a collection of bytes) but these can also be filenames, each of which contains the contents of the key written out with <code>writeBin</code>.</p>
<p>First, generate keys for Alice:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1">key_a &lt;-<span class="st"> </span>sodium<span class="op">::</span><span class="kw">keygen</span>()</a>
<a class="sourceLine" id="cb45-2" title="2">pub_a &lt;-<span class="st"> </span>sodium<span class="op">::</span><span class="kw">pubkey</span>(key_a)</a></code></pre></div>
<p>the public key is derived from the private key, and Alice can share that with Bob. We next generate Bob’s keys</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" title="1">key_b &lt;-<span class="st"> </span>sodium<span class="op">::</span><span class="kw">keygen</span>()</a>
<a class="sourceLine" id="cb46-2" title="2">pub_b &lt;-<span class="st"> </span>sodium<span class="op">::</span><span class="kw">pubkey</span>(key_b)</a></code></pre></div>
<p>Bob would now share is public key with Alice.</p>
<p>If Alice wants to send a message to Bob she again uses her private key and Bob’s public key:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" title="1">pair_a &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">keypair_sodium</span>(pub_b, key_a)</a></code></pre></div>
<p>As above, she can now send a message:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1">secret &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">encrypt_string</span>(<span class="st">&quot;secret message&quot;</span>, pair_a)</a>
<a class="sourceLine" id="cb48-2" title="2">secret</a></code></pre></div>
<pre><code>##  [1] f3 ac 15 fa f7 d1 cc 3a 39 35 88 a0 ff 5a be 2a c2 38 08 22 f8 7e b1
## [24] cf 32 9e 71 68 38 f9 7c 85 93 bc 5e 4e 84 8e 7c 9e 2c 41 1e 42 18 2b
## [47] 7b 37 cf 85 8d 84 b0 cb</code></pre>
<p>Note how this line is identical to the one in the <code>openssl</code> section.</p>
<p>To decrypt this message, Bob would use Alice’s public key and his private key:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" title="1">pair_b &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">keypair_sodium</span>(pub_a, key_b)</a>
<a class="sourceLine" id="cb50-2" title="2">cyphr<span class="op">::</span><span class="kw">decrypt_string</span>(secret, pair_b)</a></code></pre></div>
<pre><code>## [1] &quot;secret message&quot;</code></pre>
</div>
</div>
</div>
<div id="encrypting-things" class="section level1">
<h1>Encrypting things</h1>
<p>Above, we used <code>cyphr::encrypt_string</code> and <code>cyphr::decrypt_string</code> to encrypt and decrypt a string. There are several such functions in the package that encrypt and decrypt</p>
<ul>
<li>R objects <code>encrypt_object</code> / <code>decrypt_object</code> (using serialization and deserialization)</li>
<li>strings: <code>encrypt_string</code> / <code>decrypt_string</code></li>
<li>raw vectors: <code>encrypt_data</code> / <code>decrypt_data</code></li>
<li>files: <code>encrypt_file</code> / <code>decrypt_file</code></li>
</ul>
<p>For this section we will just use a sodium symmetric encryption key</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" title="1">key &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">key_sodium</span>(sodium<span class="op">::</span><span class="kw">keygen</span>())</a></code></pre></div>
<p>For the examples below, in the case of asymmetric encryption (using either <code>cyphr::keypair_openssl</code> or <code>cyphr::keypair_sodium</code>) the sender would use their private key and the recipient’s public key and the recipient would use the complementary key pair.</p>
<div id="objects" class="section level2">
<h2>Objects</h2>
<p>Here’s an object to encrypt:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" title="1">obj &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">y =</span> <span class="st">&quot;secret&quot;</span>)</a></code></pre></div>
<p>This creates a bunch of raw bytes corresponding to the data (it’s not really possible to print this as anything nicer than bytes).</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" title="1">secret &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">encrypt_object</span>(obj, key)</a>
<a class="sourceLine" id="cb54-2" title="2">secret</a></code></pre></div>
<pre><code>##   [1] 59 57 c0 17 ec 9f de e9 01 43 6f 06 6d 7d 76 66 3a a7 d6 1e a8 87 bc
##  [24] 6e d3 78 b3 53 f1 af f3 38 c3 27 62 50 8c d8 f9 35 34 60 65 ef ac c4
##  [47] 9d a5 ab bc a2 87 7e 8a bf 8a c8 29 62 43 a2 71 3e 7c 84 2f fd fe 47
##  [70] cf 67 8a c5 b3 fc c2 db 5f 05 83 e9 fc 9e 07 41 95 68 bf 0d c9 c1 4a
##  [93] e2 69 6f f0 68 cf 48 59 11 57 45 12 22 7b cf 1f 61 14 41 ac be 56 33
## [116] a4 49 0d ef 47 b3 7b 78 ce d2 f9 1f ae f8 f7 68 13 1c c2 dc 2e f7 16
## [139] 1a e7 64 a1 ef 10 6d cc 0d 0d 09 72 b6 01 f0 ae 6d 82 75 af da 85 60
## [162] 3a fe 8d 2f 1c 0a de 0e ba cf d0 b4 ca b7 41 17 23 3e 43 31 44 0d</code></pre>
<p>The data can be decrypted with the <code>decrypt_object</code> function:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt_object</span>(secret, key)</a></code></pre></div>
<pre><code>## $x
##  [1]  1  2  3  4  5  6  7  8  9 10
## 
## $y
## [1] &quot;secret&quot;</code></pre>
<p>Optionally, this process can go via a file, using a third argument to the functions (note that temporary files are used here for compliance with CRAN policies - any path may be used in practice).</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" title="1">path_secret &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;secret.rds&quot;</span>)</a>
<a class="sourceLine" id="cb58-2" title="2">cyphr<span class="op">::</span><span class="kw">encrypt_object</span>(obj, key, path_secret)</a></code></pre></div>
<p>There is now a file called <code>secret.rds</code> in the temporary directory:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" title="1"><span class="kw">file.exists</span>(path_secret)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>though it is not actually an rds file:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" title="1"><span class="kw">readRDS</span>(path_secret)</a></code></pre></div>
<pre><code>## Error in readRDS(path_secret): unknown input format</code></pre>
<p>When passed a filename (as opposed to a raw vector), <code>cyphr::decrypt_object</code> will read the object in before decrypting it</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt_object</span>(path_secret, key)</a></code></pre></div>
<pre><code>## $x
##  [1]  1  2  3  4  5  6  7  8  9 10
## 
## $y
## [1] &quot;secret&quot;</code></pre>
</div>
<div id="strings" class="section level2">
<h2>Strings</h2>
<p>For the case of strings we can do this in a slightly more lightweight way (the above function routes through <code>serialize</code> / <code>deserialize</code> which can be slow and will create larger objects than using <code>charToRaw</code> / <code>rawToChar</code>)</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" title="1">secret &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">encrypt_string</span>(<span class="st">&quot;secret&quot;</span>, key)</a>
<a class="sourceLine" id="cb65-2" title="2">secret</a></code></pre></div>
<pre><code>##  [1] 6e 1b 54 23 f0 df fd 2c 64 7d f1 25 0b 74 09 7e 23 89 af 30 26 99 88
## [24] 75 a9 5e 85 70 39 ec 4d 14 13 99 82 30 f6 cd d1 04 64 e1 da d5 43 70</code></pre>
<p>and decrypt:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt_string</span>(secret, key)</a></code></pre></div>
<pre><code>## [1] &quot;secret&quot;</code></pre>
</div>
<div id="plain-raw-data" class="section level2">
<h2>Plain raw data</h2>
<p>If these are not enough for you, you can work directly with raw objects (bunches of bytes) by using <code>encrypt_data</code>:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" title="1">dat &lt;-<span class="st"> </span>sodium<span class="op">::</span><span class="kw">random</span>(<span class="dv">100</span>)</a>
<a class="sourceLine" id="cb69-2" title="2">dat <span class="co"># some random bytes</span></a></code></pre></div>
<pre><code>##   [1] 69 29 8f 8b f3 0f c2 eb 3f 3f 3a 20 2b 91 6e ad 2c 81 e7 f8 7a 70 e8
##  [24] db 9a 78 82 56 db cd e9 03 ef 29 14 1c cf 64 0d 65 7c aa a2 b4 e3 e4
##  [47] 6b a3 8c 1f 3a 50 68 cc 1e e3 9b 3a c8 0b 63 c1 75 b7 dd 87 e5 2b b2
##  [70] 5f fa 10 4e fe ad e4 78 b5 a3 5b bd 34 80 5e 80 ee 9e de 23 bf f2 97
##  [93] 0e 10 2c 15 f8 5e 51 0f</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" title="1">secret &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">encrypt_data</span>(dat, key)</a>
<a class="sourceLine" id="cb71-2" title="2">secret</a></code></pre></div>
<pre><code>##   [1] 0a 7e 0a 9c 45 b8 4c f7 86 c3 06 5c e4 f6 8a c4 6b cb fb 69 4e c7 3f
##  [24] f0 2a 3d 39 97 a8 43 e2 85 7e 74 4c 60 86 a2 1b 94 b4 74 66 c2 9f 8c
##  [47] 63 37 46 77 f6 0f 94 24 0c d5 eb 93 2f c2 e5 8b 9d e0 74 b1 bc f8 ac
##  [70] ab 9c f5 13 30 9c 05 6f eb 47 8a ac 65 4f 71 0f 20 ab ff fe 42 6c bd
##  [93] 17 fb ac b4 9a 1e 28 10 92 7e bb 97 c2 59 d4 45 06 82 14 53 c8 6f e9
## [116] d0 3c 73 5e 5d 2f e0 98 98 2c d2 d1 91 d9 22 3a 81 48 bc a0 44 7f b8
## [139] 1e ac</code></pre>
<p>Decrypted data is the same as a the original data</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" title="1"><span class="kw">identical</span>(cyphr<span class="op">::</span><span class="kw">decrypt_data</span>(secret, key), dat)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="files" class="section level2">
<h2>Files</h2>
<p>Suppose we have written a file that we want to encrypt to send to someone (in a temporary directory for compliance with CRAN policies)</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" title="1">path_data_csv &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;iris.csv&quot;</span>)</a>
<a class="sourceLine" id="cb75-2" title="2"><span class="kw">write.csv</span>(iris, path_data_csv, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p>You can encrypt that file with</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" title="1">path_data_enc &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;iris.csv.enc&quot;</span>)</a>
<a class="sourceLine" id="cb76-2" title="2">cyphr<span class="op">::</span><span class="kw">encrypt_file</span>(path_data_csv, key, path_data_enc)</a></code></pre></div>
<p>This encrypted file can then be decrypted with</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" title="1">path_data_decrypted &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;idis2.csv&quot;</span>)</a>
<a class="sourceLine" id="cb77-2" title="2">cyphr<span class="op">::</span><span class="kw">decrypt_file</span>(path_data_enc, key, path_data_decrypted)</a></code></pre></div>
<p>Which is identical to the original:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" title="1">tools<span class="op">::</span><span class="kw">md5sum</span>(<span class="kw">c</span>(path_data_csv, path_data_decrypted))</a></code></pre></div>
<pre><code>##  /var/folders/z7/c2kx_kt96zn2tt_6179bkc4m0000gp/T//Rtmp4OHgUv/iris.csv 
##                                     &quot;5fe92fe6a2c1928ef5a67b8939fdaf8d&quot; 
## /var/folders/z7/c2kx_kt96zn2tt_6179bkc4m0000gp/T//Rtmp4OHgUv/idis2.csv 
##                                     &quot;5fe92fe6a2c1928ef5a67b8939fdaf8d&quot;</code></pre>
</div>
</div>
<div id="an-even-higher-level-interface-for-files" class="section level1">
<h1>An even higher level interface for files</h1>
<p>This is the most user-friendly way of using the package when the aim is to encrypt and decrypt files. The package provides a pair of functions <code>cyphr::encrypt</code> and <code>cyphr::decrypt</code> that wrap file writing and file reading functions. In general you would use <code>encrypt</code> when writing a file and <code>decrypt</code> when reading one. They’re designed to be used like so:</p>
<p>Suppose you have a super-secret object that you want to share privately</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" title="1">key &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">key_sodium</span>(sodium<span class="op">::</span><span class="kw">keygen</span>())</a>
<a class="sourceLine" id="cb80-2" title="2">x &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">b =</span> <span class="st">&quot;don&#39;t tell anyone else&quot;</span>)</a></code></pre></div>
<p>If you save <code>x</code> to disk with <code>saveRDS</code> it will be readable by everyone until it is deleted. But if you encrypted the file that <code>saveRDS</code> produced it would be protected and only people with the key can read it:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" title="1">path_object &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;secret.rds&quot;</span>)</a>
<a class="sourceLine" id="cb81-2" title="2">cyphr<span class="op">::</span><span class="kw">encrypt</span>(<span class="kw">saveRDS</span>(x, path_object), key)</a></code></pre></div>
<p>(see below for some more details on how this works).</p>
<p>This file cannot be read with <code>readRDS</code>:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" title="1"><span class="kw">readRDS</span>(path_object)</a></code></pre></div>
<pre><code>## Error in readRDS(path_object): unknown input format</code></pre>
<p>but if we wrap the call with <code>decrypt</code> and pass in the config object it can be decrypted and read:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt</span>(<span class="kw">readRDS</span>(path_object), key)</a></code></pre></div>
<pre><code>## $a
##  [1]  1  2  3  4  5  6  7  8  9 10
## 
## $b
## [1] &quot;don&#39;t tell anyone else&quot;</code></pre>
<p>What happens in the call above is <code>cyphr</code> uses “non standard evaluation” to rewrite the call above so that it becomes (approximately)</p>
<ol style="list-style-type: decimal">
<li>use <code>cyphr::decrypt_file</code> to decrypt “secret.rds” as a temporary file</li>
<li>call <code>readRDS</code> on that temporary file</li>
<li>delete the temporary file (even if there is an error in the above calls)</li>
</ol>
<p>This non-standard evaluation breaks referential integrity (so may not be suitable for programming). You can always do this manually with <code>encrypt_file</code> / <code>decrypt_file</code> so long as you make sure to clean up after yourself.</p>
<p>The <code>encrypt</code> function inspects the call in the first argument passed to it and works out for the function provided (<code>saveRDS</code>) which argument corresponds to the filename (here <code>&quot;secret.rds&quot;</code>). It then rewrites the call to write out to a temporary file (using <code>tempfile()</code>). Then it calls <code>encrypt_file</code> (see below) on this temporary file to create the file asked for (<code>&quot;secret.rds&quot;</code>). Then it deletes the temporary file, though this will also happen in case of an error in any of the above.</p>
<p>The <code>decrypt</code> function works similarly. It inspects the call and detects that the first argument represents the filename. It decrypts that file to create a temporary file, and then runs <code>readRDS</code> on that file. Again it will delete the temporary file on exit.</p>
<p>The functions supported via this interface are:</p>
<ul>
<li><code>readLines</code> / <code>writeLines</code></li>
<li><code>readRDS</code> / <code>writeRDS</code></li>
<li><code>read</code> / <code>save</code></li>
<li><code>read.table</code> / <code>write.table</code></li>
<li><code>read.csv</code> / <code>read.csv2</code> / <code>write.csv</code></li>
<li><code>read.delim</code> / <code>read.delim2</code></li>
</ul>
<p>But new functions can be added with the <code>rewrite_register</code> function. For example, to support the excellent <a href="https://cran.r-project.org/package=rio">rio</a> package, whose <code>import</code> and <code>export</code> functions take the filename <code>file</code> you could use:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" title="1">cyphr<span class="op">::</span><span class="kw">rewrite_register</span>(<span class="st">&quot;rio&quot;</span>, <span class="st">&quot;import&quot;</span>, <span class="st">&quot;file&quot;</span>)</a>
<a class="sourceLine" id="cb86-2" title="2">cyphr<span class="op">::</span><span class="kw">rewrite_register</span>(<span class="st">&quot;rio&quot;</span>, <span class="st">&quot;export&quot;</span>, <span class="st">&quot;file&quot;</span>)</a></code></pre></div>
<p>now you can read and write tabular data into and out of a great many different file formats with encryption with calls like</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" title="1">cyphr<span class="op">::</span><span class="kw">encrypt</span>(rio<span class="op">::</span><span class="kw">export</span>(mtcars, <span class="st">&quot;file.json&quot;</span>), key)</a>
<a class="sourceLine" id="cb87-2" title="2">cyphr<span class="op">::</span><span class="kw">decrypt</span>(rio<span class="op">::</span><span class="kw">import</span>(<span class="st">&quot;file.json&quot;</span>), key)</a></code></pre></div>
<p>The functions above use <a href="http://adv-r.had.co.nz/Computing-on-the-language.html">non standard evaluation</a> and so may not be suitable for programming or use in packages. An “escape hatch” is provided via <code>encrypt_</code> and <code>decrypt_</code> where the first argument is a quoted expression.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" title="1">cyphr<span class="op">::</span><span class="kw">encrypt_</span>(<span class="kw">quote</span>(<span class="kw">saveRDS</span>(x, path_object)), key)</a>
<a class="sourceLine" id="cb88-2" title="2">cyphr<span class="op">::</span><span class="kw">decrypt_</span>(<span class="kw">quote</span>(<span class="kw">readRDS</span>(path_object)), key)</a></code></pre></div>
<pre><code>## $a
##  [1]  1  2  3  4  5  6  7  8  9 10
## 
## $b
## [1] &quot;don&#39;t tell anyone else&quot;</code></pre>
</div>
<div id="session-keys" class="section level1">
<h1>Session keys</h1>
<p>When using <code>key_openssl</code>, <code>keypair_openssl</code>, <code>key_sodium</code>, or <code>keypair_sodium</code> we generate something that can decrypt data. The objects that are returned by these functions can encrypt and decrypt data and so it is reasonable to be concerned that if these objects were themselves saved to disk your data would be compromised.</p>
<p>To avoid this, <code>cyphr</code> does not store private or symmetric keys directly in these objects but instead encrypts the sensitive keys with a <code>cyphr</code>-specific session key that is regenerated each time the package is loaded. This means that the objects are practically only useful within one session, and if saved with <code>save.image</code> (perhaps automatically at the end of a session) the keys cannot be used to decrypt data.</p>
<p>To manually invalidate all keys you can use the <code>cyphr::session_key_refresh</code> function. For example, here is a symmetric key:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" title="1">key &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">key_sodium</span>(sodium<span class="op">::</span><span class="kw">keygen</span>())</a></code></pre></div>
<p>which we can use to encrypt a secret string</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" title="1">secret &lt;-<span class="st"> </span>cyphr<span class="op">::</span><span class="kw">encrypt_string</span>(<span class="st">&quot;my secret&quot;</span>, key)</a></code></pre></div>
<p>and decrypt it:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt_string</span>(secret, key)</a></code></pre></div>
<pre><code>## [1] &quot;my secret&quot;</code></pre>
<p>If we refresh the session key we invalidate the <code>key</code> object</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" title="1">cyphr<span class="op">::</span><span class="kw">session_key_refresh</span>()</a></code></pre></div>
<p>and after this point the key cannot be used any further</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" title="1">cyphr<span class="op">::</span><span class="kw">decrypt_string</span>(secret, key)</a></code></pre></div>
<pre><code>## Error in is.raw(key): Failed to decrypt key as session key has changed</code></pre>
<p>This approach works because the package holds the session key within its environment (in <code>cyphr:::session$key</code>) which R will not serialize. As noted above - this approach does not prevent an attacker with the ability to snoop on your R session from discovering your private keys or sensitive data but it does prevent accidentally saving keys in a way that would be useful for an attacker to use in a subsequent session.</p>
</div>
<div id="further-reading" class="section level1">
<h1>Further reading</h1>
<ul>
<li>The wikipedia page on Public Key cryptography has some nice diagrams that explain how key and data interact <a href="https://en.wikipedia.org/wiki/Public-key_cryptography" class="uri">https://en.wikipedia.org/wiki/Public-key_cryptography</a></li>
<li>The vignettes in the <code>openssl</code> (<code>vignette(package = &quot;openssl&quot;)</code>) and <code>sodium</code> (<code>vignette(package = &quot;openssl&quot;)</code>) packages have explanations of how the tools used in <code>cyphr</code> work and interface with R.</li>
</ul>
<p>Confused? Need help? Found a bug?</p>
<ul>
<li>Post an issue on the <a href="https://github.com/ropensci/cyphr/issues"><code>cyphr</code> issue tracker</a></li>
<li>Start a discussion on the <a href="https://discuss.ropensci.org/">rOpenSci discussion forum</a></li>
</ul>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
